name: "Cobol-like-Java — Build + ProofLedger + Auto Release"

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "example.cobj"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: cobol-like-java-${{ github.ref }}
  cancel-in-progress: true


jobs:
  build-3os:
    name: "Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      # ----------------------------------------------------------
      # Checkout
      # ----------------------------------------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # ----------------------------------------------------------
      # Install Java (Ubuntu)
      # ----------------------------------------------------------
      - name: Install Java (Ubuntu Only)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'


      # ----------------------------------------------------------
      # Build JAR (Ubuntu Only)
      # ----------------------------------------------------------
      - name: Build (Ubuntu Only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p out
          javac src/*.java -d out
          jar --create --file cobol-like-java-${{ github.sha }}.jar -C out .


      # ----------------------------------------------------------
      # Build Skip (macOS/Windows)
      # ----------------------------------------------------------
      - name: Skip Build (Non-Ubuntu)
        if: matrix.os != 'ubuntu-latest'
        run: |
          echo "Java build skipped for ${{ matrix.os }}" > skip.txt


      # ----------------------------------------------------------
      # ProofLedger (UNIX shells)
      # ----------------------------------------------------------
      - name: ProofLedger (macOS / Ubuntu)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          PL="proofledger-${{ matrix.os }}-${{ github.sha }}.txt"
          echo "Repository: Cobol-like-Java" > $PL
          echo "Commit: ${{ github.sha }}" >> $PL
          echo "OS: ${{ matrix.os }}" >> $PL
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            echo "Build: SUCCESS" >> $PL
          else
            echo "Build: SKIPPED" >> $PL
          fi


      # ----------------------------------------------------------
      # ProofLedger (Windows)
      # ----------------------------------------------------------
      - name: ProofLedger (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $PL = "proofledger-${{ matrix.os }}-${{ github.sha }}.txt"
          "Repository: Cobol-like-Java" >  $PL
          "Commit: ${{ github.sha }}"   >> $PL
          "OS: ${{ matrix.os }}"        >> $PL
          "Build: SKIPPED"              >> $PL


      # ----------------------------------------------------------
      # Upload JAR (Ubuntu)
      # ----------------------------------------------------------
      - name: Upload JAR
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: cobol-java-jar-${{ github.sha }}
          path: cobol-like-java-${{ github.sha }}.jar


      # ----------------------------------------------------------
      # Upload Skip file
      # ----------------------------------------------------------
      - name: Upload Skip
        if: matrix.os != 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: skip-${{ matrix.os }}-${{ github.sha }}
          path: skip.txt


      # ----------------------------------------------------------
      # Upload ProofLedger
      # ----------------------------------------------------------
      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}-${{ github.sha }}
          path: proofledger-${{ matrix.os }}-${{ github.sha }}.txt



  # ====================================================================
  # RELEASE JOB
  # ====================================================================
  release:
    needs: build-3os
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.sha }}
          name: "Auto Release — ${{ github.sha }}"
          files: |
            artifacts/**/cobol-like-java-*.jar
            artifacts/**/*.txt

