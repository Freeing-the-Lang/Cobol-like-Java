name: "Cobol-like-Java — Build + ProofLedger + Auto Release"

on:
  push:
    branches: [ "main" ]
    paths:
      - "src/**"
      - "example.cobj"
      - ".github/workflows/**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: cobol-like-java-${{ github.ref }}
  cancel-in-progress: true


jobs:
  build-3os:
    name: "Build — ${{ matrix.os }}"
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0


      # ============================================================
      #  Install Java (Ubuntu Only)
      # ============================================================
      - name: Install Java (Ubuntu Only)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'


      # ============================================================
      #  Build (Ubuntu Only)
      # ============================================================
      - name: Build (Ubuntu Only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p out
          javac src/*.java -d out
          jar --create --file cobol-like-java.jar -C out .


      # ============================================================
      #  Build Skip (macOS/Windows)
      # ============================================================
      - name: Skip Build (Non-Ubuntu)
        if: matrix.os != 'ubuntu-latest'
        run: |
          echo "Java build skipped for ${{ matrix.os }}" > skip.txt


      # ============================================================
      #  ProofLedger (Ubuntu — bash)
      # ============================================================
      - name: ProofLedger (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "Repository: Cobol-like-Java" > proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Commit: ${{ github.sha }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "OS: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Build: OK" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt


      # ============================================================
      #  ProofLedger (Windows — PowerShell)
      # ============================================================
      - name: ProofLedger (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          "Repository: Cobol-like-Java" > "proofledger-${{ matrix.os }}-${{ github.sha }}.txt"
          "Commit: ${{ github.sha }}" >> "proofledger-${{ matrix.os }}-${{ github.sha }}.txt"
          "OS: ${{ matrix.os }}" >> "proofledger-${{ matrix.os }}-${{ github.sha }}.txt"
          "Build: SKIPPED" >> "proofledger-${{ matrix.os }}-${{ github.sha }}.txt"


      # ============================================================
      #  ProofLedger (macOS — bash)
      # ============================================================
      - name: ProofLedger (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "Repository: Cobol-like-Java" > proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Commit: ${{ github.sha }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "OS: ${{ matrix.os }}" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt
          echo "Build: SKIPPED" >> proofledger-${{ matrix.os }}-${{ github.sha }}.txt


      # ============================================================
      #  Upload Linux JAR / skip files / ProofLedger
      # ============================================================
      - name: Upload JAR (Ubuntu Only)
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: cobol-like-java-jar-${{ github.sha }}
          path: cobol-like-java.jar

      - name: Upload Skip File (Non-Ubuntu)
        if: matrix.os != 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: skip-${{ matrix.os }}-${{ github.sha }}
          path: skip.txt

      - name: Upload ProofLedger
        uses: actions/upload-artifact@v4
        with:
          name: proofledger-${{ matrix.os }}-${{ github.sha }}
          path: proofledger-${{ matrix.os }}-${{ github.sha }}.txt


  # ===================================================================
  #  Auto Release
  # ===================================================================
  release:
    needs: build-3os
    runs-on: ubuntu-latest

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: auto-${{ github.sha }}
          name: "Auto Release — ${{ github.sha }}"
          files: artifacts/**
